
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="培风">
      
      
        <link rel="canonical" href="https://isnthzy.github.io/src/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E9%9A%8F%E7%AC%94/">
      
      
        <link rel="prev" href="../gtkwave%E9%85%8D%E7%BD%AE%E5%BF%83%E5%BE%97/">
      
      
        <link rel="next" href="../pa3%E5%81%9A%E5%AE%8C%E7%9A%84%E7%A2%8E%E7%A2%8E%E5%BF%B5/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.3">
    
    
      
        <title>异常处理随笔 - 培风的博客</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0e669242.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="培风的博客" class="md-header__button md-logo" aria-label="培风的博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            培风的博客
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              异常处理随笔
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/isnthzy/isnthzy.github.io/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    isnthzy/isnthzy.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="培风的博客" class="md-nav__button md-logo" aria-label="培风的博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    培风的博客
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/isnthzy/isnthzy.github.io/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    isnthzy/isnthzy.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%8F%90%E9%97%AE%E7%9A%84%E6%99%BA%E6%85%A7%E8%AF%BB%E5%90%8E%E6%84%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    提问的智慧读后感
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    linux笔记
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            linux笔记
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../TMUX%E4%B8%8EVIM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TMUX与VIM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../git%E7%9A%84%E7%94%A8%E6%B3%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git用法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%E4%BD%BF%E7%94%A8man%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux使用man中文手册
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%B8%80%E7%94%9F%E4%B8%80%E8%8A%AF%E7%9A%84makefile%E7%B2%BE%E8%A7%A3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    一生一芯的makefile精解
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../Makefile%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Makefile学习随笔
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../%E9%BE%99%E8%8A%AF%E6%9D%AF%E4%B8%AA%E4%BA%BA%E8%B5%9B%E5%9C%A8%E7%BA%BF%E7%BC%96%E8%AF%91%E6%95%99%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    龙芯杯个人赛编译教程
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../Verilog%E9%9A%8F%E7%AC%94/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Verilog笔记
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../NJU%20PA1-%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E6%89%8B%E5%86%8C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NJU PA1-如何阅读手册
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../ELF%E6%96%87%E4%BB%B6%E6%80%8E%E4%B9%88%E8%AF%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ELF文件怎么读
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../PA2.1%E4%B8%80%E6%9D%A1%E6%8C%87%E4%BB%A4%E5%9C%A8NEMU%E4%B8%AD%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NJU PA2.1一条指令在NEMU中的执行过程
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B1%82%E5%80%BC%E6%B7%B1%E8%A7%A3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    表达式求值深解
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../__am_gpu_config%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E8%A1%8C%E4%BC%98%E5%85%88%E5%AD%98%E5%82%A8%E6%98%AF%E4%BB%80%E4%B9%88/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    __am_gpu_config的实现以及行优先存储是什么
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../Chisel%E7%9A%84scala%20maven%E6%BA%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chisel的scala maven源
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../compile_commands.json%E6%9B%B4%E5%85%88%E8%BF%9B%E7%9A%84%E8%BE%85%E5%8A%A9%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    compile_commands.json随笔
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../difftest%E7%B3%BB%E7%BB%9F%E8%B8%A9%E5%9D%91%E8%A7%A3%E8%AF%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    difftest系统踩坑解读
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../gtkwave%E9%85%8D%E7%BD%AE%E5%BF%83%E5%BE%97/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gtkwave配置心得
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    异常处理随笔
  </span>
  

      </a>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../pa3%E5%81%9A%E5%AE%8C%E7%9A%84%E7%A2%8E%E7%A2%8E%E5%BF%B5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pa3做完的碎碎念
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="_1">异常处理随笔<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>首先，一个很重要的表，居然在开放架构设计之道中没有读到（选择正确的手册）</p>
<p><img alt="在这里插入图片描述" src="../typora-user-images/%E4%B8%AA%E4%BA%BA%E5%AF%B9%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/watermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0hHR3NoaXdv%2Csize_16%2Ccolor_FFFFFF%2Ct_70-1703423230167-3.png" /></p>
<p><img alt="在这里插入图片描述" src="../typora-user-images/%E4%B8%AA%E4%BA%BA%E5%AF%B9%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/watermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0hHR3NoaXdv%2Csize_16%2Ccolor_FFFFFF%2Ct_70-1703423299395-5-1703423301823-8.png" /></p>
<p><img alt="在这里插入图片描述" src="../typora-user-images/%E4%B8%AA%E4%BA%BA%E5%AF%B9%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/watermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0hHR3NoaXdv%2Csize_16%2Ccolor_FFFFFF%2Ct_70.png" /></p>
<p><img alt="在这里插入图片描述" src="../typora-user-images/%E4%B8%AA%E4%BA%BA%E5%AF%B9%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/watermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0hHR3NoaXdv%2Csize_16%2Ccolor_FFFFFF%2Ct_70-1703423328621-12.png" /></p>
<p>要躲避的几个坑点：</p>
<p>1.实现difftest的时候要读一下源码，difftest同步寄存器的时候赋值方式是不一样的</p>
<p>2.nemu一直是M最高权限级别<img alt="image-20231226175624940" src="../typora-user-images/%E4%B8%AA%E4%BA%BA%E5%AF%B9%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/image-20231226175624940.png" /></p>
<p>3.多读手册</p>
<p>4.第一个地方的要求行为和native并不一样，做到正确跳转即可</p>
<p>通过调试器扫描内存和观察寄存器可以得出</p>
<div class="highlight"><pre><span></span><code>trap.S解读
80001488 &lt;__am_asm_trap&gt;:
80001488:   f7010113            addi    sp,sp,-144 //在内存中分配栈帧
8000148c:   00112223            sw  ra,4(sp)       //把寄存器的值传递到sp所指的内存上存储
80001490:   00312623            sw  gp,12(sp)
80001494:   00412823            sw  tp,16(sp)
80001498:   00512a23            sw  t0,20(sp)
8000149c:   00612c23            sw  t1,24(sp)
800014a0:   00712e23            sw  t2,28(sp)
800014a4:   02812023            sw  s0,32(sp)
800014a8:   02912223            sw  s1,36(sp)
800014ac:   02a12423            sw  a0,40(sp)
800014b0:   02b12623            sw  a1,44(sp)
800014b4:   02c12823            sw  a2,48(sp)
800014b8:   02d12a23            sw  a3,52(sp)
800014bc:   02e12c23            sw  a4,56(sp)
800014c0:   02f12e23            sw  a5,60(sp)
800014c4:   05012023            sw  a6,64(sp)
800014c8:   05112223            sw  a7,68(sp)
800014cc:   05212423            sw  s2,72(sp)
800014d0:   05312623            sw  s3,76(sp)
800014d4:   05412823            sw  s4,80(sp)
800014d8:   05512a23            sw  s5,84(sp)
800014dc:   05612c23            sw  s6,88(sp)
800014e0:   05712e23            sw  s7,92(sp)
800014e4:   07812023            sw  s8,96(sp)
800014e8:   07912223            sw  s9,100(sp)
800014ec:   07a12423            sw  s10,104(sp)
800014f0:   07b12623            sw  s11,108(sp)
800014f4:   07c12823            sw  t3,112(sp)
800014f8:   07d12a23            sw  t4,116(sp)
800014fc:   07e12c23            sw  t5,120(sp)
80001500:   07f12e23            sw  t6,124(sp)
80001504:   342022f3            csrr    t0,mcause   //把寄存器mcause的值读入t0
80001508:   30002373            csrr    t1,mstatus  //把寄存器mstatus的值读入t1
8000150c:   341023f3            csrr    t2,mepc     //把寄存器mepc的值读入t2
80001510:   08512023            sw  t0,128(sp)      //将这三者也存入栈帧中
80001514:   08612223            sw  t1,132(sp)
80001518:   08712423            sw  t2,136(sp)
8000151c:   00020537            lui a0,0x20
80001520:   00a36333            or  t1,t1,a0
80001524:   30031073            csrw    mstatus,t1
80001528:   00010513            mv  a0,sp
8000152c:   e65ff0ef            jal ra,80001390 &lt;__am_irq_handle&gt; //异常处理就是读这个结构体，从内存里读结构体
80001530:   08412303            lw  t1,132(sp)      //把栈帧132位置的值写入寄存器t1
80001534:   08812383            lw  t2,136(sp)      //把栈帧136位置的值写入寄存器t2
80001538:   30031073            csrw    mstatus,t1  //把寄存器t1的值写入mstatus
8000153c:   34139073            csrw    mepc,t2     //把寄存器t2的值写入mepc
80001540:   00412083            lw  ra,4(sp)        //恢复lw
80001544:   00c12183            lw  gp,12(sp)
80001548:   01012203            lw  tp,16(sp)
8000154c:   01412283            lw  t0,20(sp)
80001550:   01812303            lw  t1,24(sp)
80001554:   01c12383            lw  t2,28(sp)
80001558:   02012403            lw  s0,32(sp)
8000155c:   02412483            lw  s1,36(sp)
80001560:   02812503            lw  a0,40(sp)
80001564:   02c12583            lw  a1,44(sp)
80001568:   03012603            lw  a2,48(sp)
8000156c:   03412683            lw  a3,52(sp)
80001570:   03812703            lw  a4,56(sp)
80001574:   03c12783            lw  a5,60(sp)
80001578:   04012803            lw  a6,64(sp)
8000157c:   04412883            lw  a7,68(sp)
80001580:   04812903            lw  s2,72(sp)
80001584:   04c12983            lw  s3,76(sp)
80001588:   05012a03            lw  s4,80(sp)
8000158c:   05412a83            lw  s5,84(sp)
80001590:   05812b03            lw  s6,88(sp)
80001594:   05c12b83            lw  s7,92(sp)
80001598:   06012c03            lw  s8,96(sp)
8000159c:   06412c83            lw  s9,100(sp)
800015a0:   06812d03            lw  s10,104(sp)
800015a4:   06c12d83            lw  s11,108(sp)
800015a8:   07012e03            lw  t3,112(sp)
800015ac:   07412e83            lw  t4,116(sp)
800015b0:   07812f03            lw  t5,120(sp)
800015b4:   07c12f83            lw  t6,124(sp)
800015b8:   09010113            addi    sp,sp,144
800015bc:   30200073            mret
800015c0:   0000                    .2byte  0x0
    ...
</code></pre></div>
<p><img alt="image-20231227192347511" src="../typora-user-images/%E4%B8%AA%E4%BA%BA%E5%AF%B9%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/image-20231227192347511.png" /></p>
<div class="highlight"><pre><span></span><code>mstatus的状态
    MPP       MPIE
    12 11     7
000 1  1  000 0   000 0000 =0x1800
              1   000 0000 =0x80
110&lt;&lt;11
110 000 0000 0000
</code></pre></div>
<p>又又又被坑了，这里实现的不够完整</p>
<p>/home/wangxin/ysyx-workbench/abstract-machine/am/src/riscv/nemu/cte.c</p>
<div class="highlight"><pre><span></span><code>Context* __am_irq_handle(Context *c) {
  if (user_handler) {
    Event ev = {0};
    switch (c-&gt;mcause) {
      case 0xb: //11 Environment call from M-mode
        if(c-&gt;GPR1==-1){
          ev.event=EVENT_YIELD;
        }else{ 
          //典中典之pa后边的部分被pa前面的实现坑惨，后边要求为识别的异常时间编号为4，但是经过检查发现
          //自己的输出为0，几番定位定位到这里给了0，照理说传入不对的数据都应该给0
          ev.event=EVENT_ERROR;
        }
        break;
      default: ev.event = EVENT_ERROR; break;
    }

    c = user_handler(ev, c);
    assert(c != NULL);
  }

  return c;
}
</code></pre></div>
<p>为什么要清零?</p>
<p>为什么需要将 <code>[VirtAddr + FileSiz, VirtAddr + MemSiz)</code> 对应的物理区间清零?</p>
<p>例如</p>
<div class="highlight"><pre><span></span><code>Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .text             PROGBITS        830000b4 0000b4 0050d0 00  AX  0   0  4
  [ 2] .rodata           PROGBITS        83005184 005184 000244 00   A  0   0  4
  [ 3] .data             PROGBITS        830063c8 0053c8 000830 00  WA  0   0  8
  [ 4] .sdata            PROGBITS        83006bf8 005bf8 000068 00  WA  0   0  4
  [ 5] .sbss             NOBITS          83006c60 005c60 000014 00  WA  0   0  4
  [ 6] .bss              NOBITS          83006c74 005c60 000028 00  WA  0   0  4
  [ 7] .comment          PROGBITS        00000000 005c60 00002b 01  MS  0   0  1
  [ 8] .riscv.attributes RISCV_ATTRIBUTE 00000000 005c8b 00001f 00      0   0  1
  [ 9] .symtab           SYMTAB          00000000 005cac 000f10 10     10 116  4
  [10] .strtab           STRTAB          00000000 006bbc 00071b 00      0   0  1
  [11] .shstrtab         STRTAB          00000000 0072d7 00005c 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  D (mbind), p (processor specific)

There are no section groups in this file.

Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  RISCV_ATTRIBUT 0x005c8b 0x00000000 0x00000000 0x0001f 0x00000 R   0x1
  LOAD           0x000000 0x83000000 0x83000000 0x053c8 0x053c8 R E 0x1000
  LOAD           0x0053c8 0x830063c8 0x830063c8 0x00898 0x008d4 RW  0x1000
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x10
</code></pre></div>
<p>摘取重点信息</p>
<div class="highlight"><pre><span></span><code>Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 6] .bss              NOBITS          83006c74 005c60 000028 00  WA  0   0  4

  Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  LOAD           0x000000 0x83000000 0x83000000 0x053c8 0x053c8 R E 0x1000
  LOAD           0x0053c8 0x830063c8 0x830063c8 0x00898 0x008d4 RW  0x1000
</code></pre></div>
<p>通过计算得知.bss的addr对应：83006c74=0x830063c8（VirtAddr ）+ 0x00898</p>
<p>(size)000028=0x008d4(MemSiz)-(0x00898)FileSiz</p>
<p>因为可以得出[VirtAddr + FileSiz, VirtAddr + MemSiz)对应的物理区间即为.bss段</p>
<p>查阅手册得知   .bss This section holds uninitialized data that contributes to the</p>
<p>​    <em>program's memory image.  By definition, the system  initializes</em> </p>
<p>​    <em>the data with zeros when the program begins to run.  This section is</em> </p>
<p>​    *of type SHT_NOBITS.  The attribute types are SHF_ALLOC and SHF_WRITE.</p>
<p>mepc的+4  ‘/home/wangxin/ysyx-workbench/abstract-machine/am/src/riscv/nemu/cte.c‘</p>
<p>重回顾：</p>
<p>代码将会一路返回到<code>trap.S</code>的<code>__am_asm_trap()</code>中, 接下来的事情就是恢复程序的上下文. <code>__am_asm_trap()</code>将根据之前保存的上下文内容, 恢复程序的状态, 最后执行"异常返回指令"返回到程序触发异常之前的状态.</p>
<p>不过这里需要注意之前自陷指令保存的PC, 对于x86的<code>int</code>指令, 保存的是指向其下一条指令的PC, 这有点像函数调用; 而对于mips32的<code>syscall</code>和riscv32的<code>ecall</code>, <strong>保存的是自陷指令的PC, 因此软件需要在适当的地方对保存的PC加上4, 使得将来返回到自陷指令的下一条指令.</strong></p>
<p>从加4操作看CISC和RISC</p>
<p><strong>事实上, 自陷只是其中一种异常类型. 有一种故障类异常, 它们返回的PC和触发异常的PC是同一个, 例如缺页异常, 在系统将故障排除后, 将会重新执行相同的指令进行重试, 因此异常返回的PC无需加4. 所以根据异常类型的不同, 有时候需要加4, 有时候则不需要加.</strong></p>
<p>这时候, 我们就可以考虑这样的一个问题了: 决定要不要加4的, 是硬件还是软件呢? CISC和RISC的做法正好相反, CISC都交给硬件来做, 而RISC则交给软件来做. 思考一下, 这两种方案各有什么取舍? 你认为哪种更合理呢? 为什么?</p>
<p>所以我们需要在软件上实现+4</p>
<p>所以为什么difftest检查不出这个错误也显而易见了：</p>
<p><strong>因为自陷的返回目标位置是由软件决定的，软件中没有这个行为，自然也编译不出来这个mepc+4指令，因而diff行为也无法对比</strong></p>
<p>系统调用，画出状态转移状态机。</p>
<div class="highlight"><pre><span></span><code>init_irq -&gt; cte_init  -&gt;.......-&gt; naive_uload -&gt; dummy -&gt; _syscall_ -&gt; _am_asm_trap
                                                                             |
  do_event(put(&quot;C&quot;)) &lt;- (EVENT_SYSCALL)  _am_irq_handle   &lt;- _am_asm_trap  &lt;-+
      |
      + -&gt; do_syscall -&gt; SYS_yeild -&gt; yeild() -&gt; ....put(&quot;Y&quot;) ....... -&gt; return^n
                                                                            |
         halt(gpr1) &lt;- SYS_exit &lt;- do_syscall   &lt;-  ......    &lt;- gpr1=0 &lt;—  +
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 - 2023 Wang Xin
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.78eede0e.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>